extends layout.pug 

//- ? posts å˜é‡è·å– `res.render("somepug", {posts: val1})`
block content

  div.posts-wrapper
    div.clearfix
      a(href='/addpost/').mx-1.float-end.btn.btn-small.btn-light åˆ›å»ºå¸–å­
      if (user) 
        a(href=`/users/${user.id}` type='submit').mx-1.float-end.btn.btn-small.btn-light ä¸ªäººä¿¡æ¯é¡µ

      form#postsViewModeForm(action='/' method='get')
        select#vm.float-start(name='vm' class='form-select' aria-label='Default select example' style='width:30%;')
          //- vm - viewmode ; t: time ; w: weight; h: hot; r: recently
          option(disabled value='disabled') æ’åºæ–¹æ¡ˆ
          option(value='t') å‘å¸–æ—¶é—´
          option(value='w') æƒé‡ä¸‹æ²‰
          option(value='h') æµè§ˆçƒ­åº¦
          option(value='r') æœ€è¿‘å›å¤
        button.mx-1.btn.btn-small.btn-light(type='submit') ç¡®å®š
    ul.posts-list.list-group.list-group-flush.my-3.mb-3.p-3.bg-body.rounded.shadow-sm
      
      each post in posts 
        //- TODO å¦‚ä¸‹bootstrap æ ·å¼å¾…ä¼˜åŒ–
        li.list-group-item.post-item
          .row.mb-3
            a(href='/users/'+post.userId title=post.email).col.flex-grow-0.flex-shrink-0: img(style="border:3px solid "+ post.bdcolor width="50" height="50" src='/upload/user_avatar/'+post.avatar).post-avatar.rounded-circle
            //- img(width="50" height="50" src='/upload/user_avatar/'+post.avatar).post-avatar.col.flex-grow-0.flex-shrink-0.rounded-circle
            div.col
              - var badgeClass = [post.clicks<5?'bg-light text-dark':'',post.clicks>=5&&post.clicks<10?'bg-secondary':'',post.clicks>=10 && post.clicks < 20?'bg-primary':'',post.clicks>=20 && post.clicks<50? 'bg-danger':'', post.clicks>=50? 'bg-warning':'']
              //- ä¸´æ—¶tag
              span.badge.bg-light.text-dark.float-end.mx-1 W-#{post.weight}

              span.badge.float-end(class=badgeClass) #{post.clicks >= 20 ? 'ğŸ”¥ HOT ':'æµè§ˆæ•°ï¼š'}#{post.clicks}
              a.post-title.fs-5(href='/posts/'+post.id)= post.title.slice(0,15)+'...'
              br
              span.text-secondary #[a(href='/users/'+post.userId) #{post.nickname}] 
              br

              span å‘å¸–@ #{new Date(post.timestamp).toLocaleString()}
              if user && post.userId == user.id
                button.delpost-btn.btn.btn-sm.btn-outline-danger.mx-2.float-end(data-post-id=post.id style='height:24px') &times;
              if post.lastCmtStamp !== 0
                span.text-secondary.float-end  æœ€è¿‘å›å¤@ #{new Date(post.lastCmtStamp).toLocaleString()}
      else 
        p ç½‘ç«™æš‚æ—¶æ²¡æœ‰å¸–å­ï¼Œæ¥æš–æš–åœºï¼

    //- å€ŸåŠ©æ­¤ï¼ˆå®é™…localStorageï¼‰ è®©view-modeçš„selectæ¡† åœ¨è¯·æ±‚åˆ°é¡µé¢æ—¶æ¡†å†…å°±èƒ½å¤Ÿå®æ—¶æ˜¾ç¤º å¸–å­æ’åºæ¨¡å¼ ï¼ˆå¯é€šè¿‡æ³¨é‡Šä¸‹è¡Œçœ‹æ•ˆæœï¼ï¼‰
    script(src="/public/javascripts/for-view-mode.js") 


    nav(aria-label='...')
      ul.pagination.m-auto(style='width:min-content;')
        li.page-item(class={disabled: pageInfo.curPage === 1})
          a.page-link(href=`/?p=${+pageInfo.curPage-1}&vm=${vm}` tabindex='-1') &laquo;
        each pageNum in Array(pageInfo.pagesCou).fill(0).map((_,idx) => idx + 1)
          li.page-item(class={active:  pageNum === pageInfo.curPage}) 
            a.page-link(href=`/?p=${pageNum}&vm=${vm}`)= pageNum
        li.page-item(class={disabled: pageInfo.curPage === pageInfo.pagesCou})
          a.page-link(href=`/?p=${+pageInfo.curPage+1}&vm=${vm||'h'}`) &raquo;

    script. 
      $('body').on('click', '.delpost-btn', function (e) {
        const ans = confirm('ç¡®å®šè¦åˆ é™¤è¯¥å‘å¸–å—ï¼Ÿåˆ é™¤åä¸å¯æ’¤å›ã€‚')
        if (!ans) return
        
        $.ajax(`/posts/${$(e.target).data('post-id')}`, {
          method: 'delete'
        })
          .then(_ => {
            $(e.target).closest('.post-item').remove()
          })
          .catch(rej => {
            alert(rej.responseText)
          })
      })
